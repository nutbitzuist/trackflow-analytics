<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackFlow Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
                            400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
                            800: '#3730a3', 900: '#312e81',
                        }
                    },
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-card {
            background: rgba(30, 30, 40, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ... existing animations ... */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = 'https://trackflow-backend-production.up.railway.app';

        // Icons Component (simplified)
        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
            Globe: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Code: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Dollar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        };

        // Auth Form Component
        const AuthForm = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
                    const res = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await res.json();

                    if (!res.ok) throw new Error(data.error || 'Authentication failed');

                    if (data.token) {
                        onLogin(data.user, data.token);
                    } else if (!isLogin) {
                        // Auto login after register if possible, or switch to login
                        setIsLogin(true);
                        setError('Account created! Please log in.');
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 p-4">
                    <div className="glass-card w-full max-w-md p-8 rounded-2xl shadow-xl animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-12 h-12 bg-primary-600 rounded-xl mx-auto flex items-center justify-center text-white font-bold text-2xl mb-4">T</div>
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>
                            <p className="text-slate-500 mt-2">Sign in to manage your analytics</p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-rose-100 text-rose-600 rounded-lg text-sm text-center">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 outline-none focus:ring-2 focus:ring-primary-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 outline-none focus:ring-2 focus:ring-primary-500"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-medium transition-colors disabled:opacity-50"
                            >
                                {loading ? 'Loading...' : (isLogin ? 'Sign In' : 'Sign Up')}
                            </button>
                        </form>

                        <div className="mt-6 text-center text-sm">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-primary-600 hover:underline"
                            >
                                {isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [loading, setLoading] = useState(true);
            const [sites, setSites] = useState([]);
            const [selectedSite, setSelectedSite] = useState(null);
            const [activeView, setActiveView] = useState('dashboard');

            // Data States (Simplified for brevity, similar to previous version)
            const [stats, setStats] = useState(null);
            const [revenueData, setRevenueData] = useState(null);

            // Auth Check
            useEffect(() => {
                const storedToken = localStorage.getItem('token');
                if (storedToken) {
                    // Validate token
                    fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${storedToken}` }
                    })
                        .then(res => {
                            if (res.ok) return res.json();
                            throw new Error('Invalid token');
                        })
                        .then(data => {
                            setUser(data.user);
                            setToken(storedToken);
                            setLoading(false);
                        })
                        .catch(() => {
                            handleLogout();
                            setLoading(false);
                        });
                } else {
                    setLoading(false);
                }
            }, []);

            // Data Fetching
            useEffect(() => {
                if (token && !sites.length) fetchSites();
            }, [token]);

            useEffect(() => {
                if (selectedSite && token) {
                    fetchStats();
                    if (activeView === 'revenue') fetchRevenue();
                }
            }, [selectedSite, activeView, token]);

            const handleLogin = (user, token) => {
                localStorage.setItem('token', token);
                setToken(token);
                setUser(user);
            };

            const handleLogout = () => {
                localStorage.removeItem('token');
                setToken(null);
                setUser(null);
                setSites([]);
                setSelectedSite(null);
            };

            const authenticatedFetch = async (url, options = {}) => {
                const headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                const res = await fetch(`${API_BASE}${url}`, { ...options, headers });
                if (res.status === 401 || res.status === 403) {
                    handleLogout();
                    throw new Error('Unauthorized');
                }
                return res.json();
            };

            const fetchSites = async () => {
                try {
                    const data = await authenticatedFetch('/api/sites');
                    setSites(data);
                    if (data.length > 0 && !selectedSite) setSelectedSite(data[0].id);
                } catch (e) { console.error(e); }
            };

            const fetchStats = async () => {
                try {
                    const data = await authenticatedFetch(`/api/sites/${selectedSite}/stats`);
                    setStats(data);
                } catch (e) { console.error(e); }
            };

            const fetchRevenue = async () => {
                try {
                    const data = await authenticatedFetch(`/api/sites/${selectedSite}/revenue`);
                    setRevenueData(data);
                } catch (e) { console.error(e); }
            };

            const handleAddSite = async (name, domain) => {
                try {
                    const newSite = await authenticatedFetch('/api/sites', {
                        method: 'POST',
                        body: JSON.stringify({ name, domain })
                    });
                    setSites([newSite, ...sites]);
                    setSelectedSite(newSite.id);
                } catch (e) { alert('Failed to add site'); }
            };

            if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;
            if (!token) return <AuthForm onLogin={handleLogin} />;

            // Helper to render current view content
            const renderContent = () => {
                if (!selectedSite) return <div className="p-8 text-center">Create a site to get started.</div>;

                if (activeView === 'revenue') {
                    return (
                        <div className="glass-card p-6 rounded-2xl">
                            <h3 className="font-bold mb-4">Revenue Attribution</h3>
                            {revenueData ? (
                                <table className="w-full">
                                    <thead><tr><th className="text-left py-2">Source</th><th className="text-right">Revenue</th></tr></thead>
                                    <tbody>
                                        {revenueData.bySource?.map((row, i) => (
                                            <tr key={i} className="border-t border-slate-100 dark:border-slate-800">
                                                <td className="py-3">{row.source}</td>
                                                <td className="py-3 text-right font-mono text-emerald-500">${row.revenue}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : 'Loading...'}
                        </div>
                    );
                }

                // Default Dashboard
                return (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="glass-card p-6 rounded-2xl">
                            <span className="text-sm text-slate-500">Unique Visitors</span>
                            <div className="text-3xl font-bold mt-2">{stats?.unique_visitors || 0}</div>
                        </div>
                        <div className="glass-card p-6 rounded-2xl">
                            <span className="text-sm text-slate-500">Page Views</span>
                            <div className="text-3xl font-bold mt-2">{stats?.total_pageviews || 0}</div>
                        </div>
                        <div className="glass-card p-6 rounded-2xl">
                            <span className="text-sm text-slate-500">Total Sessions</span>
                            <div className="text-3xl font-bold mt-2">{stats?.total_sessions || 0}</div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-64 glass-card border-r border-slate-200 dark:border-slate-800 p-6 flex flex-col">
                        <div className="font-bold text-xl mb-8 flex items-center gap-2">
                            <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center text-white">T</div>
                            TrackFlow
                        </div>

                        {/* Site Selector */}
                        <div className="mb-6">
                            <select
                                value={selectedSite || ''}
                                onChange={e => setSelectedSite(e.target.value)}
                                className="w-full p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
                            >
                                {sites.map(s => <option key={s.id} value={s.id}>{s.domain}</option>)}
                            </select>
                            <button
                                onClick={() => {
                                    const d = prompt('Domain:');
                                    if (d) handleAddSite(d, d);
                                }}
                                className="mt-2 w-full py-2 text-sm text-primary-600 border border-dashed border-primary-300 rounded-lg hover:bg-primary-50"
                            >
                                + Add Website
                            </button>
                        </div>

                        <nav className="space-y-1 flex-1">
                            <button onClick={() => setActiveView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg ${activeView === 'dashboard' ? 'bg-primary-50 text-primary-600' : 'hover:bg-slate-100'}`}>
                                <Icons.Dashboard /> Dashboard
                            </button>
                            <button onClick={() => setActiveView('revenue')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg ${activeView === 'revenue' ? 'bg-primary-50 text-primary-600' : 'hover:bg-slate-100'}`}>
                                <Icons.Dollar /> ROI / Revenue
                            </button>
                        </nav>

                        <button onClick={handleLogout} className="flex items-center gap-3 px-4 py-3 text-slate-500 hover:text-slate-900">
                            <Icons.Logout /> Logout
                        </button>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-8 overflow-auto">
                        <header className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-bold capitalize">{activeView}</h1>
                            <div className="text-sm text-slate-500">{user?.email}</div>
                        </header>
                        {renderContent()}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>