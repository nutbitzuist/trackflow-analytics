<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackFlow Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
                            400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
                            800: '#3730a3', 900: '#312e81',
                        }
                    },
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-card {
            background: rgba(30, 30, 40, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Hero gradient */
        .hero-gradient {
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 100%);
        }

        .dark .hero-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = 'https://trackflow-backend-production.up.railway.app';

        // --- ICONS ---
        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
            Live: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z" /></svg>,
            Dollar: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Eye: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Code: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Globe: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Device: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
            Campaign: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg>,
            Event: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" /></svg>,
        };

        // --- PUBLIC COMPONENTS ---

        const Navbar = ({ onNavigate }) => (
            <nav className="flex items-center justify-between px-6 py-4 max-w-7xl mx-auto w-full">
                <div className="flex items-center gap-2 font-bold text-xl cursor-pointer" onClick={() => onNavigate('landing')}>
                    <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center text-white">T</div>
                    TrackFlow
                </div>
                <div className="hidden md:flex items-center gap-8 text-sm font-medium text-slate-600 dark:text-slate-300">
                    <a href="#" className="hover:text-primary-600">Features</a>
                    <a href="#" className="hover:text-primary-600">Pricing</a>
                    <a href="#" className="hover:text-primary-600">Blog</a>
                </div>
                <div className="flex items-center gap-4">
                    <button onClick={() => onNavigate('login')} className="text-sm font-medium hover:text-primary-600">Sign in</button>
                    <button onClick={() => onNavigate('register')} className="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors">Start Free Trial</button>
                </div>
            </nav>
        );

        const LandingPage = ({ onNavigate }) => (
            <div className="min-h-screen bg-slate-50 dark:bg-slate-900">
                <Navbar onNavigate={onNavigate} />

                {/* Hero */}
                <section className="pt-20 pb-32 px-6 text-center max-w-5xl mx-auto">
                    <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary-50 text-primary-600 text-xs font-medium mb-8 border border-primary-100">
                        <span className="relative flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-primary-500"></span></span>
                        v2.0 is now live
                    </div>
                    <h1 className="text-5xl md:text-7xl font-bold tracking-tight text-slate-900 dark:text-white mb-6">
                        Analytics for <span className="text-primary-600">modern teams</span>.
                    </h1>
                    <p className="text-xl text-slate-500 max-w-2xl mx-auto mb-10">
                        From pageviews to payments, clicks to conversions. The only analytics platform you need to understand your users without compromising privacy.
                    </p>
                    <div className="flex justify-center gap-4 mb-16">
                        <button onClick={() => onNavigate('register')} className="px-8 py-4 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-bold text-lg transition-transform hover:scale-105 shadow-lg shadow-primary-500/20">Start Free Trial</button>
                        <button onClick={() => onNavigate('login')} className="px-8 py-4 bg-white dark:bg-slate-800 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">Live Demo</button>
                    </div>
                    <div className="relative mx-auto rounded-xl shadow-2xl border border-slate-200 dark:border-slate-800 overflow-hidden bg-white dark:bg-slate-900">
                        <img src="dashboard-mockup.png" alt="Dashboard Preview" className="w-full h-auto" />
                        <div className="absolute inset-0 bg-gradient-to-t from-slate-50/50 dark:from-slate-900/50 to-transparent pointer-events-none"></div>
                    </div>
                </section>

                {/* Features */}
                <section className="py-24 bg-white dark:bg-slate-800/50">
                    <div className="max-w-7xl mx-auto px-6 grid md:grid-cols-3 gap-12">
                        <div className="text-left">
                            <div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center mb-6"><Icons.Globe /></div>
                            <h3 className="text-xl font-bold mb-3">Privacy First</h3>
                            <p className="text-slate-500">GDPR compliant by default. No cookies, no IP tracking, just pure data ownership.</p>
                        </div>
                        <div className="text-left">
                            <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center mb-6"><Icons.Live /></div>
                            <h3 className="text-xl font-bold mb-3">Real-time Data</h3>
                            <p className="text-slate-500">See visitors as they arrive. Live view updates instantly with every page load and event.</p>
                        </div>
                        <div className="text-left">
                            <div className="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center mb-6"><Icons.Code /></div>
                            <h3 className="text-xl font-bold mb-3">Lightweight Script</h3>
                            <p className="text-slate-500">Less than 2KB. Loads asynchrnously and never slows down your site performance.</p>
                        </div>
                    </div>
                </section>

                {/* Footer */}
                <footer className="py-12 border-t border-slate-200 dark:border-slate-800 text-center text-slate-500 text-sm">
                    <div className="flex items-center justify-center gap-2 font-bold text-xl text-slate-900 dark:text-white mb-4">
                        <div className="w-6 h-6 bg-primary-600 rounded flex items-center justify-center text-white text-xs">T</div>
                        TrackFlow
                    </div>
                    <p>&copy; 2025 TrackFlow Analytics. All rights reserved.</p>
                </footer>
            </div>
        );

        // --- AUTH COMPONENTS ---

        const AuthForm = ({ isLoginMode, onLogin, onNavigate }) => {
            const [isLogin, setIsLogin] = useState(isLoginMode);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => setIsLogin(isLoginMode), [isLoginMode]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
                    const res = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Authentication failed');
                    if (data.token) {
                        onLogin(data.user, data.token);
                    } else if (!isLogin) {
                        setIsLogin(true);
                        setError('Account created! Please log in.');
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 p-4 relative">
                    <div className="absolute top-6 left-6 cursor-pointer font-bold text-xl flex items-center gap-2" onClick={() => onNavigate('landing')}>
                        <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center text-white">T</div>
                        TrackFlow
                    </div>
                    <div className="glass-card w-full max-w-md p-8 rounded-2xl shadow-xl animate-fade-in">
                        <div className="text-center mb-8">
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{isLogin ? 'Welcome Back' : 'Create Account'}</h2>
                            <p className="text-slate-500 mt-2">Sign in to manage your analytics</p>
                        </div>
                        {error && <div className="mb-4 p-3 bg-rose-100 text-rose-600 rounded-lg text-sm text-center">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 outline-none focus:ring-2 focus:ring-primary-500" required placeholder="Email" />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 outline-none focus:ring-2 focus:ring-primary-500" required placeholder="Password" />
                            <button type="submit" disabled={loading} className="w-full py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-medium transition-colors disabled:opacity-50">
                                {loading ? 'Loading...' : (isLogin ? 'Sign In' : 'Sign Up')}
                            </button>
                        </form>
                        <div className="mt-6 text-center text-sm">
                            <button onClick={() => { setIsLogin(!isLogin); onNavigate(isLogin ? 'register' : 'login'); }} className="text-primary-600 hover:underline">{isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in"}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD COMPONENT (Protected) ---

        const Dashboard = ({ user, token, onLogout }) => {
            const [sites, setSites] = useState([]);
            const [selectedSite, setSelectedSite] = useState(null);
            const [activeView, setActiveView] = useState('dashboard');

            // Data States
            const [stats, setStats] = useState(null);
            const [revenueData, setRevenueData] = useState(null);
            const [liveData, setLiveData] = useState({ count: 0, visitors: [] });
            const [topPages, setTopPages] = useState([]);
            const [sources, setSources] = useState([]);
            const [countries, setCountries] = useState([]);
            const [devices, setDevices] = useState(null);
            const [campaigns, setCampaigns] = useState([]);
            const [events, setEvents] = useState([]);

            const authenticatedFetch = async (url, options = {}) => {
                const res = await fetch(`${API_BASE}${url}`, {
                    ...options,
                    headers: { ...options.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });
                if (res.status === 401 || res.status === 403) { onLogout(); throw new Error('Unauthorized'); }
                return res.json();
            };

            useEffect(() => { fetchSites(); }, []);

            useEffect(() => {
                if (!selectedSite) return;
                const endpoints = {
                    dashboard: () => authenticatedFetch(`/api/sites/${selectedSite}/stats`).then(setStats),
                    revenue: () => authenticatedFetch(`/api/sites/${selectedSite}/revenue`).then(setRevenueData),
                    realtime: () => authenticatedFetch(`/api/sites/${selectedSite}/realtime`).then(setLiveData),
                    pages: () => authenticatedFetch(`/api/sites/${selectedSite}/pages`).then(setTopPages),
                    sources: () => authenticatedFetch(`/api/sites/${selectedSite}/sources`).then(setSources),
                    locations: () => authenticatedFetch(`/api/sites/${selectedSite}/countries`).then(setCountries),
                    devices: () => authenticatedFetch(`/api/sites/${selectedSite}/devices`).then(setDevices),
                    campaigns: () => authenticatedFetch(`/api/sites/${selectedSite}/campaigns`).then(setCampaigns),
                    events: () => authenticatedFetch(`/api/sites/${selectedSite}/events`).then(setEvents)
                };
                if (endpoints[activeView]) endpoints[activeView]().catch(console.error);
            }, [selectedSite, activeView]);

            const fetchSites = async () => { try { const data = await authenticatedFetch('/api/sites'); setSites(data); if (data.length > 0 && !selectedSite) setSelectedSite(data[0].id); } catch (e) { } };
            const handleAddSite = async (name, domain) => { try { const newSite = await authenticatedFetch('/api/sites', { method: 'POST', body: JSON.stringify({ name, domain }) }); setSites([newSite, ...sites]); setSelectedSite(newSite.id); } catch (e) { alert('Failed'); } };
            const handleDeleteSite = async () => { if (confirm('Are you sure?')) { await authenticatedFetch(`/api/sites/${selectedSite}`, { method: 'DELETE' }); window.location.reload(); } };

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Dashboard /> },
                { id: 'realtime', label: 'Real-time', icon: <Icons.Live /> },
                { id: 'revenue', label: 'ROI / Revenue', icon: <Icons.Dollar /> },
                { id: 'pages', label: 'Top Pages', icon: <Icons.Eye /> },
                { id: 'sources', label: 'Sources', icon: <Icons.Chart /> },
                { id: 'locations', label: 'Locations', icon: <Icons.Globe /> },
                { id: 'devices', label: 'Devices', icon: <Icons.Device /> },
                { id: 'campaigns', label: 'Campaigns', icon: <Icons.Campaign /> },
                { id: 'events', label: 'Events', icon: <Icons.Event /> },
                { id: 'script', label: 'Get Script', icon: <Icons.Code /> },
                { id: 'settings', label: 'Settings', icon: <Icons.Settings /> },
            ];

            return (
                <div className="flex h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white overflow-hidden">
                    <aside className="w-64 glass-card border-r border-slate-200 dark:border-slate-800 p-6 flex flex-col overflow-y-auto hidden md:flex">
                        <div className="font-bold text-xl mb-8 flex items-center gap-2">
                            <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center text-white">T</div>
                            TrackFlow
                        </div>
                        <div className="mb-6">
                            <select value={selectedSite || ''} onChange={e => setSelectedSite(e.target.value)} className="w-full p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                                {sites.map(s => <option key={s.id} value={s.id}>{s.domain}</option>)}
                            </select>
                            <button onClick={() => { const d = prompt('Domain:'); if (d) handleAddSite(d, d); }} className="mt-2 w-full py-2 text-sm text-primary-600 border border-dashed border-primary-300 rounded-lg hover:bg-primary-50">+ Add Website</button>
                        </div>
                        <nav className="space-y-1 flex-1">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => setActiveView(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeView === item.id ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-600' : 'hover:bg-slate-100 dark:hover:bg-slate-800'}`}>
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>
                        <button onClick={onLogout} className="flex items-center gap-3 px-4 py-3 text-slate-500 hover:text-slate-900 mt-4"><Icons.Logout /> Logout</button>
                    </aside>
                    <main className="flex-1 p-8 overflow-auto">
                        <header className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-bold capitalize">{menuItems.find(i => i.id === activeView)?.label || activeView}</h1>
                            <div className="text-sm text-slate-500">{user?.email}</div>
                        </header>
                        {!selectedSite ? <div className="p-8 text-center">Create a site to get started.</div> : (
                            <>
                                {activeView === 'dashboard' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                                        <div className="glass-card p-6 rounded-2xl">
                                            <span className="text-sm text-slate-500">Unique Visitors</span>
                                            <div className="text-3xl font-bold mt-2">{stats?.unique_visitors || 0}</div>
                                        </div>
                                        <div className="glass-card p-6 rounded-2xl">
                                            <span className="text-sm text-slate-500">Page Views</span>
                                            <div className="text-3xl font-bold mt-2">{stats?.total_pageviews || 0}</div>
                                        </div>
                                        <div className="glass-card p-6 rounded-2xl">
                                            <span className="text-sm text-slate-500">Total Sessions</span>
                                            <div className="text-3xl font-bold mt-2">{stats?.total_sessions || 0}</div>
                                        </div>
                                    </div>
                                )}

                                {activeView === 'realtime' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="flex items-center gap-4">
                                            <div className="relative"><div className="w-4 h-4 bg-emerald-500 rounded-full animate-ping absolute" /><div className="w-4 h-4 bg-emerald-500 rounded-full relative" /></div>
                                            <span className="text-4xl font-bold">{liveData.count}</span>
                                            <span className="text-slate-500">active visitors</span>
                                        </div>
                                        <div className="glass-card p-6 rounded-2xl">
                                            <h3 className="font-bold mb-4">Active Sessions</h3>
                                            <div className="space-y-3">{liveData.visitors?.map((v, i) => (
                                                <div key={i} className="flex justify-between items-center p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
                                                    <div><div className="font-medium">{v.path}</div><div className="text-xs text-slate-500">{v.device_type} â€¢ {v.country}</div></div>
                                                    <div className="text-emerald-500 text-sm font-bold">Active</div>
                                                </div>
                                            ))}</div>
                                        </div>
                                    </div>
                                )}

                                {activeView === 'revenue' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Revenue Attribution</h3>
                                        <table className="w-full">
                                            <thead><tr><th className="text-left py-2">Source</th><th className="text-right">Revenue</th></tr></thead>
                                            <tbody>{revenueData?.bySource?.map((row, i) => (
                                                <tr key={i} className="border-t border-slate-100 dark:border-slate-800">
                                                    <td className="py-3">{row.source}</td>
                                                    <td className="py-3 text-right font-mono text-emerald-500">${row.revenue}</td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                )}

                                {activeView === 'pages' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Top Pages</h3>
                                        <div className="space-y-4">{topPages.map((page, i) => (
                                            <div key={i} className="flex justify-between items-center">
                                                <span className="font-mono text-sm">{page.path}</span>
                                                <span className="font-bold">{page.views} views</span>
                                            </div>
                                        ))}</div>
                                    </div>
                                )}

                                {activeView === 'sources' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Traffic Sources</h3>
                                        <div className="space-y-4">{sources.map((s, i) => (
                                            <div key={i} className="flex justify-between items-center">
                                                <span>{s.source}</span>
                                                <span className="font-bold">{s.visitors} visitors</span>
                                            </div>
                                        ))}</div>
                                    </div>
                                )}

                                {activeView === 'locations' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Top Locations</h3>
                                        <div className="space-y-4">{countries.map((c, i) => (
                                            <div key={i} className="flex justify-between items-center">
                                                <span>{c.citry} {c.country} ({c.city})</span>
                                                <span className="font-bold">{c.visitors} visitors</span>
                                            </div>
                                        ))}
                                            {countries.length === 0 && <span className="text-slate-500">No data available</span>}
                                        </div>
                                    </div>
                                )}

                                {/* ... Other sections identical to before (Devices, Campaigns, Events) ... */}
                                {activeView === 'devices' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                                        <div className="glass-card p-6 rounded-2xl">
                                            <h3 className="font-bold mb-4">Devices</h3>
                                            {devices?.devices?.map((d, i) => <div key={i} className="flex justify-between py-2 border-b border-slate-100 dark:border-slate-800 last:border-0"><span>{d.device_type}</span><span className="font-bold">{d.visitors}</span></div>)}
                                        </div>
                                        <div className="glass-card p-6 rounded-2xl">
                                            <h3 className="font-bold mb-4">Browsers</h3>
                                            {devices?.browsers?.map((d, i) => <div key={i} className="flex justify-between py-2 border-b border-slate-100 dark:border-slate-800 last:border-0"><span>{d.browser}</span><span className="font-bold">{d.visitors}</span></div>)}
                                        </div>
                                    </div>
                                )}

                                {activeView === 'campaigns' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Campaign Performance</h3>
                                        <table className="w-full">
                                            <thead><tr><th className="text-left py-2">Campaign</th><th className="text-left">Source/Medium</th><th className="text-right">Visitors</th></tr></thead>
                                            <tbody>{campaigns.map((c, i) => (
                                                <tr key={i} className="border-t border-slate-100 dark:border-slate-800">
                                                    <td className="py-3 font-medium">{c.utm_campaign || '-'}</td>
                                                    <td className="py-3 text-sm text-slate-500">{c.utm_source} / {c.utm_medium}</td>
                                                    <td className="py-3 text-right">{c.visitors}</td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                )}

                                {activeView === 'events' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Custom Events</h3>
                                        <div className="space-y-4">{events.map((e, i) => (
                                            <div key={i} className="flex justify-between items-center p-3 bg-white/50 dark:bg-slate-800/50 rounded-lg">
                                                <span className="font-medium">{e.event_name}</span>
                                                <div className="flex gap-4 text-sm"><span>{e.count} events</span><span className="text-slate-500">{e.unique_users} users</span></div>
                                            </div>
                                        ))}</div>
                                    </div>
                                )}

                                {activeView === 'script' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4">Tracking Script</h3>
                                        <pre className="bg-slate-900 text-slate-100 p-4 rounded-xl text-xs overflow-x-auto font-mono">
                                            {`<!-- TrackFlow Analytics -->
<script>
  (function(w,d,s,l,i){
    w[l]=w[l]||[];
    var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s);
    j.async=true;
    j.src='https://trackflow-backend-production.up.railway.app/t.js';
    j.setAttribute('data-site','${selectedSite}');
    f.parentNode.insertBefore(j,f);
  })(window,document,'script','tf','TF-${selectedSite}');
<\/script>`}
                                        </pre>
                                    </div>
                                )}

                                {activeView === 'settings' && (
                                    <div className="glass-card p-6 rounded-2xl animate-fade-in border-l-4 border-rose-500">
                                        <h3 className="font-bold text-rose-600 mb-2">Danger Zone</h3>
                                        <button onClick={handleDeleteSite} className="px-4 py-2 bg-rose-100 text-rose-600 rounded-lg hover:bg-rose-200 font-medium">Delete Website</button>
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        // --- ROOT APP & ROUTER ---

        const App = () => {
            const [view, setView] = useState('landing'); // landing, login, register, dashboard
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const storedToken = localStorage.getItem('token');
                if (storedToken) {
                    fetch(`${API_BASE}/api/auth/me`, { headers: { 'Authorization': `Bearer ${storedToken}` } })
                        .then(res => res.ok ? res.json() : Promise.reject('Invalid token'))
                        .then(data => {
                            setUser(data.user);
                            setToken(storedToken);
                            setView('dashboard'); // Redirect to dashboard if logged in
                        })
                        .catch(() => {
                            localStorage.removeItem('token');
                        })
                        .finally(() => setLoading(false));
                } else { setLoading(false); }
            }, []);

            const handleLogin = (user, token) => {
                localStorage.setItem('token', token);
                setToken(token);
                setUser(user);
                setView('dashboard');
            };

            const handleLogout = () => {
                localStorage.removeItem('token');
                setToken(null);
                setUser(null);
                setView('landing');
            };

            const navigate = (page) => {
                if (page === 'dashboard' && !token) { setView('login'); return; }
                setView(page);
            };

            if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;

            if (token && view === 'dashboard') {
                return <Dashboard user={user} token={token} onLogout={handleLogout} />;
            }

            if (view === 'login' || view === 'register') {
                return <AuthForm isLoginMode={view === 'login'} onLogin={handleLogin} onNavigate={navigate} />;
            }

            return <LandingPage onNavigate={navigate} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>